# =====================================
# Copyright 2024-2025, Andrew Lindesay
# Distributed under the terms of the MIT License.
# =====================================

# Build the hvif2png tooling

FROM base AS hvif2png-build

# 2025-10-17
ENV HAIKU_HASH=b1a1645de42b9b3a76ab0d8df0dafa58414a13b6
ENV BUILDTOOLS_HASH=7ab022f6e65571ab9e1054f62976a358652f3af8

RUN apt-get update && \
    apt-get -y install git nasm bc autoconf automake texinfo flex bison gawk build-essential unzip wget \
        zip less zlib1g-dev libzstd-dev xorriso libtool gcc-multilib python3 libpng16-16 libpng-dev

ADD "https://github.com/haiku/buildtools/archive/${BUILDTOOLS_HASH}.tar.gz" /buildtools.tgz
ADD "https://github.com/haiku/haiku/archive/${HAIKU_HASH}.tar.gz" /haiku.tgz

RUN tar -xzf ./buildtools.tgz
RUN tar -xzf ./haiku.tgz

RUN mv buildtools-${BUILDTOOLS_HASH} buildtools
RUN mv haiku-${HAIKU_HASH} haiku

WORKDIR "/buildtools/jam"
RUN make && ./jam0 install

RUN mkdir "/generated.x86_64"
WORKDIR "/generated.x86_64"
RUN ../haiku/configure --host-only

RUN apt-get -y install libpng-dev

RUN HAIKU_REVISION=123 jam -q "<build>hvif2png"